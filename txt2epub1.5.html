<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TXT 转 EPUB</title>
<style>
body{font-family:-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial,sans-serif;padding:20px;background:#f6f7f9;}
h2{margin-top:0;}
label{display:block;margin-top:10px;font-size:14px;color:#333;}
input[type="file"],input[type="text"],textarea{margin-top:5px;padding:8px;width:100%;max-width:600px;}
button{margin-top:15px;margin-right:10px;padding:10px 20px;background:#0c64f2;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
button:disabled{background:#ccc;cursor:not-allowed;}
progress{width:100%;height:14px;margin-top:10px;}
pre{background:#fff;padding:10px;border-radius:6px;max-height:300px;overflow:auto;}
</style>
</head>
<body>
<h2>TXT 转 EPUB</h2>

<label>选择 TXT 文件：
  <input id="fileInput" type="file" accept=".txt,text/plain" />
</label>

<label>书名：
  <input id="titleInput" type="text" placeholder="默认文件名" />
</label>

<label>作者：
  <input id="authorInput" type="text" placeholder="可留空" />
</label>

<label>章节识别规则（逗号分隔，支持正则表达式）：</label>
<textarea id="rulesInput" rows="3">第[一二三四五六七八九十百千0-9]+[章节回卷篇],番外,^[0-9]{1,4}$</textarea>

<button id="testBtn" disabled>测试规则</button>
<button id="convertBtn" disabled>转换并下载</button>

<progress id="progress" value="0" max="100"></progress>
<div id="status">等待中…</div>

<pre id="preview"></pre>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const fileInput=document.getElementById('fileInput');
const convertBtn=document.getElementById('convertBtn');
const testBtn=document.getElementById('testBtn');
const titleInput=document.getElementById('titleInput');
const authorInput=document.getElementById('authorInput');
const rulesInput=document.getElementById('rulesInput');
const preview=document.getElementById('preview');
const progress=document.getElementById('progress');
const status=document.getElementById('status');

let decodedText='', chapters=[];

// 📖 文件选择
fileInput.addEventListener('change', e=>{
  const f=e.target.files[0];if(!f)return;
  status.textContent='正在读取文件…';
  progress.value=5;

  // 用 FileReader（更兼容大文件）
  const reader=new FileReader();
  reader.onload=function(ev){
    let text=ev.target.result;
    if(!text || text.trim()===''){ 
      // 如果 UTF-8 失败，再试 GBK
      const fr2=new FileReader();
      fr2.onload=function(ev2){
        decodedText=ev2.target.result;
        afterLoad(f);
      };
      fr2.readAsText(f,"gbk");
    } else {
      decodedText=text;
      afterLoad(f);
    }
  };
  reader.readAsText(f,"utf-8");
});

// 文件读完 → 解析章节
function afterLoad(f){
  status.textContent='解析章节中…';
  progress.value=20;
  chapters=splitChapters(decodedText,getChapterRegex());
  preview.textContent=`检测到 ${chapters.length} 章。\n前5章：\n`+
    chapters.slice(0,5).map(c=>c.title).join('\n');
  convertBtn.disabled=false;
  testBtn.disabled=false;
  status.textContent='就绪';
  progress.value=30;
}

// 测试规则
testBtn.addEventListener('click',()=>{
  if(!decodedText){alert('请先选择文件');return;}
  const re=getChapterRegex();
  const testChapters=splitChapters(decodedText,re);
  preview.textContent=`测试规则结果：共 ${testChapters.length} 章\n`+
    testChapters.map((c,i)=>`${i+1}. ${c.title}`).join('\n');
  status.textContent='规则测试完成 ✅';
});

// 转换
convertBtn.addEventListener('click',async()=>{
  if(!decodedText){alert('请先选择文件');return;}
  const bookTitle=titleInput.value.trim()||fileInput.files[0].name.replace(/\.txt$/i,'');
  const bookAuthor=authorInput.value.trim()||'佚名';
  progress.value=40;status.textContent='开始转换…';
  const zip=new JSZip();
  zip.file('mimetype','application/epub+zip',{compression:'STORE'});
  zip.file('META-INF/container.xml',
`<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
 <rootfiles>
  <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
 </rootfiles>
</container>`);
  progress.value=50;status.textContent='写入章节…';
  chapters.forEach((c,i)=>{
    zip.file(`OEBPS/${c.id}.xhtml`,
`<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"><body>
<p style="font-weight:bold;">${c.title}</p>
<p>${c.content.replace(/\n+/g,'</p><p>')}</p>
</body></html>`);
    if(i%20===0)progress.value=50+Math.floor(i/chapters.length*20);
  });
  progress.value=70;status.textContent='生成目录…';
  zip.file('OEBPS/nav.xhtml',
`<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"><body><nav><ol>
${chapters.map(c=>`<li><a href="${c.id}.xhtml">${c.title}</a></li>`).join('\n')}
</ol></nav></body></html>`);
  zip.file('OEBPS/content.opf',
`<?xml version="1.0" encoding="utf-8"?>
<package version="3.0" xmlns="http://www.idpf.org/2007/opf">
 <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
  <dc:title>${bookTitle}</dc:title>
  <dc:creator>${bookAuthor}</dc:creator>
  <dc:language>zh-CN</dc:language>
 </metadata>
 <manifest>
  ${chapters.map(c=>`<item id="${c.id}" href="${c.id}.xhtml" media-type="application/xhtml+xml"/>`).join('\n')}
  <item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>
 </manifest>
 <spine>
  ${chapters.map(c=>`<itemref idref="${c.id}"/>`).join('\n')}
  <itemref idref="nav"/>
 </spine>
</package>`);
  progress.value=85;status.textContent='打包…';
  const blob=await zip.generateAsync({type:"blob"},meta=>{
    progress.value=85+Math.floor((meta.percent||0)*0.15);
  });
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=bookTitle+'.epub';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  progress.value=100;status.textContent='完成 ✅';
}

// 章节规则
function getChapterRegex(){
  const rules=rulesInput.value.split(',').map(r=>r.trim()).filter(Boolean);
  return new RegExp(`^(?:\\s*)(?:${rules.join('|')})([：:\\.\\s\\-—]*[^\\n]{0,80})?`,'m');
}

// 切分章节
function splitChapters(text,re){
  const lines=text.split(/\r?\n/);const idxs=[];
  for(let i=0;i<lines.length;i++){
    const m=lines[i].match(re);if(m){
      const title=(m[0]||'').trim();
      idxs.push({line:i,title});
    }
  }
  const result=[];for(let i=0;i<idxs.length;i++){
    const cur=idxs[i],next=idxs[i+1];
    const body=lines.slice(cur.line+1,next?next.line:lines.length).join('\n').trim();
    result.push({id:'ch'+(i+1),title:cur.title,content:body});
  }
  return result.length?result:[{id:'ch1',title:'全文',content:text}];
}
</script>
</body>
</html>