<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TXT è½¬ EPUB</title>
<style>
body{font-family:-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial,sans-serif;padding:20px;background:#f6f7f9;}
h2{margin-top:0;}
label{display:block;margin-top:10px;font-size:14px;color:#333;}
input[type="file"],input[type="text"],textarea{margin-top:5px;padding:8px;width:100%;max-width:600px;}
button{margin-top:15px;margin-right:10px;padding:10px 20px;background:#0c64f2;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
button:disabled{background:#ccc;cursor:not-allowed;}
progress{width:100%;height:14px;margin-top:10px;}
pre{background:#fff;padding:10px;border-radius:6px;max-height:300px;overflow:auto;}
</style>
</head>
<body>
<h2>TXT è½¬ EPUB</h2>

<label>é€‰æ‹© TXT æ–‡ä»¶ï¼š
  <input id="fileInput" type="file" accept=".txt,text/plain" />
</label>

<label>ä¹¦åï¼š
  <input id="titleInput" type="text" placeholder="é»˜è®¤æ–‡ä»¶å" />
</label>

<label>ä½œè€…ï¼š
  <input id="authorInput" type="text" placeholder="å¯ç•™ç©º" />
</label>

<label>ç« èŠ‚è¯†åˆ«è§„åˆ™ï¼ˆé€—å·åˆ†éš”ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼‰ï¼š</label>
<textarea id="rulesInput" rows="3">ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ0-9]+[ç« èŠ‚å›å·ç¯‡],ç•ªå¤–,^[0-9]{1,4}$</textarea>

<button id="testBtn" disabled>æµ‹è¯•è§„åˆ™</button>
<button id="convertBtn" disabled>è½¬æ¢å¹¶ä¸‹è½½</button>

<progress id="progress" value="0" max="100"></progress>
<div id="status">ç­‰å¾…ä¸­â€¦</div>

<pre id="preview"></pre>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const fileInput=document.getElementById('fileInput');
const convertBtn=document.getElementById('convertBtn');
const testBtn=document.getElementById('testBtn');
const titleInput=document.getElementById('titleInput');
const authorInput=document.getElementById('authorInput');
const rulesInput=document.getElementById('rulesInput');
const preview=document.getElementById('preview');
const progress=document.getElementById('progress');
const status=document.getElementById('status');

let decodedText='', chapters=[];

// ğŸ“– æ–‡ä»¶é€‰æ‹©
fileInput.addEventListener('change', e=>{
  const f=e.target.files[0];if(!f)return;
  status.textContent='æ­£åœ¨è¯»å–æ–‡ä»¶â€¦';
  progress.value=5;

  // ç”¨ FileReaderï¼ˆæ›´å…¼å®¹å¤§æ–‡ä»¶ï¼‰
  const reader=new FileReader();
  reader.onload=function(ev){
    let text=ev.target.result;
    if(!text || text.trim()===''){ 
      // å¦‚æœ UTF-8 å¤±è´¥ï¼Œå†è¯• GBK
      const fr2=new FileReader();
      fr2.onload=function(ev2){
        decodedText=ev2.target.result;
        afterLoad(f);
      };
      fr2.readAsText(f,"gbk");
    } else {
      decodedText=text;
      afterLoad(f);
    }
  };
  reader.readAsText(f,"utf-8");
});

// æ–‡ä»¶è¯»å®Œ â†’ è§£æç« èŠ‚
function afterLoad(f){
  status.textContent='è§£æç« èŠ‚ä¸­â€¦';
  progress.value=20;
  chapters=splitChapters(decodedText,getChapterRegex());
  preview.textContent=`æ£€æµ‹åˆ° ${chapters.length} ç« ã€‚\nå‰5ç« ï¼š\n`+
    chapters.slice(0,5).map(c=>c.title).join('\n');
  convertBtn.disabled=false;
  testBtn.disabled=false;
  status.textContent='å°±ç»ª';
  progress.value=30;
}

// æµ‹è¯•è§„åˆ™
testBtn.addEventListener('click',()=>{
  if(!decodedText){alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');return;}
  const re=getChapterRegex();
  const testChapters=splitChapters(decodedText,re);
  preview.textContent=`æµ‹è¯•è§„åˆ™ç»“æœï¼šå…± ${testChapters.length} ç« \n`+
    testChapters.map((c,i)=>`${i+1}. ${c.title}`).join('\n');
  status.textContent='è§„åˆ™æµ‹è¯•å®Œæˆ âœ…';
});

// è½¬æ¢
convertBtn.addEventListener('click',async()=>{
  if(!decodedText){alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');return;}
  const bookTitle=titleInput.value.trim()||fileInput.files[0].name.replace(/\.txt$/i,'');
  const bookAuthor=authorInput.value.trim()||'ä½šå';
  progress.value=40;status.textContent='å¼€å§‹è½¬æ¢â€¦';
  const zip=new JSZip();
  zip.file('mimetype','application/epub+zip',{compression:'STORE'});
  zip.file('META-INF/container.xml',
`<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
 <rootfiles>
  <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
 </rootfiles>
</container>`);
  progress.value=50;status.textContent='å†™å…¥ç« èŠ‚â€¦';
  chapters.forEach((c,i)=>{
    zip.file(`OEBPS/${c.id}.xhtml`,
`<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"><body>
<p style="font-weight:bold;">${c.title}</p>
<p>${c.content.replace(/\n+/g,'</p><p>')}</p>
</body></html>`);
    if(i%20===0)progress.value=50+Math.floor(i/chapters.length*20);
  });
  progress.value=70;status.textContent='ç”Ÿæˆç›®å½•â€¦';
  zip.file('OEBPS/nav.xhtml',
`<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"><body><nav><ol>
${chapters.map(c=>`<li><a href="${c.id}.xhtml">${c.title}</a></li>`).join('\n')}
</ol></nav></body></html>`);
  zip.file('OEBPS/content.opf',
`<?xml version="1.0" encoding="utf-8"?>
<package version="3.0" xmlns="http://www.idpf.org/2007/opf">
 <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
  <dc:title>${bookTitle}</dc:title>
  <dc:creator>${bookAuthor}</dc:creator>
  <dc:language>zh-CN</dc:language>
 </metadata>
 <manifest>
  ${chapters.map(c=>`<item id="${c.id}" href="${c.id}.xhtml" media-type="application/xhtml+xml"/>`).join('\n')}
  <item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>
 </manifest>
 <spine>
  ${chapters.map(c=>`<itemref idref="${c.id}"/>`).join('\n')}
  <itemref idref="nav"/>
 </spine>
</package>`);
  progress.value=85;status.textContent='æ‰“åŒ…â€¦';
  const blob=await zip.generateAsync({type:"blob"},meta=>{
    progress.value=85+Math.floor((meta.percent||0)*0.15);
  });
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=bookTitle+'.epub';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  progress.value=100;status.textContent='å®Œæˆ âœ…';
}

// ç« èŠ‚è§„åˆ™
function getChapterRegex(){
  const rules=rulesInput.value.split(',').map(r=>r.trim()).filter(Boolean);
  return new RegExp(`^(?:\\s*)(?:${rules.join('|')})([ï¼š:\\.\\s\\-â€”]*[^\\n]{0,80})?`,'m');
}

// åˆ‡åˆ†ç« èŠ‚
function splitChapters(text,re){
  const lines=text.split(/\r?\n/);const idxs=[];
  for(let i=0;i<lines.length;i++){
    const m=lines[i].match(re);if(m){
      const title=(m[0]||'').trim();
      idxs.push({line:i,title});
    }
  }
  const result=[];for(let i=0;i<idxs.length;i++){
    const cur=idxs[i],next=idxs[i+1];
    const body=lines.slice(cur.line+1,next?next.line:lines.length).join('\n').trim();
    result.push({id:'ch'+(i+1),title:cur.title,content:body});
  }
  return result.length?result:[{id:'ch1',title:'å…¨æ–‡',content:text}];
}
</script>
</body>
</html>